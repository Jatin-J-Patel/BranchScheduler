<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Scheduler - React</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            margin: -30px -30px 30px -30px;
        }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-secondary { background: #e2e8f0; color: #334155; }
        .btn-success { background: #059669; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn:hover { transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
        }
        .form-input:focus { border-color: #2563eb; outline: none; }
        
        .tabs { display: flex; background: #f1f5f9; border-radius: 8px; margin-bottom: 30px; }
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
        }
        .tab.active { background: #2563eb; color: white; }
        
        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .employee-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .shift-list { margin-bottom: 30px; }
        .shift-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            margin-bottom: 15px;
        }
        .shift-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            cursor: pointer;
            position: relative;
        }
        .calendar-day:hover { background: #f8fafc; }
        .calendar-day.today { background: #fef3c7; }
        .calendar-day.other-month { background: #f1f5f9; opacity: 0.6; cursor: default; }
        .day-header {
            background: #2563eb;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        .day-number { font-weight: 700; margin-bottom: 8px; }
        .shift-item {
            background: #059669;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 4px;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .shift-item:hover .remove-shift { display: block; }
        .remove-shift {
            display: none;
            position: absolute;
            top: -6px;
            right: -6px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            line-height: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.open { display: block; }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        
        .shift-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        .checkbox-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #059669; }
        .notification.error { background: #dc2626; }
        .notification.warning { background: #d97706; }
        
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .month-title { font-size: 24px; font-weight: 600; }
        
        .login-types { display: flex; gap: 10px; margin-bottom: 20px; }
        .login-type {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
        }
        .login-type.active {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
        }
        
        .supervisor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number { font-size: 24px; font-weight: 700; color: #2563eb; }
        .stat-label { font-size: 14px; color: #64748b; margin-top: 5px; }
        
        .empty-state {
            text-align: center;
            color: #64748b;
            padding: 40px;
        }
        
        @media (max-width: 768px) {
            .shift-form { grid-template-columns: 1fr; }
            .calendar-day { min-height: 100px; font-size: 12px; }
            .checkbox-list { grid-template-columns: 1fr; }
            .header-actions { flex-direction: column; }
            .month-nav { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBxQ7geoG3DsmBRuM1dMM6SjUUXyUb5YtA",
            authDomain: "scheduler-8af78.firebaseapp.com",
            projectId: "scheduler-8af78",
            storageBucket: "scheduler-8af78.firebasestorage.app",
            messagingSenderId: "580854836199",
            appId: "1:580854836199:web:9d7dc1cdf9308c4cfd6b42",
            measurementId: "G-R6LDVHMBLY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Constants
        const AUTHORIZED_EMAILS = {
            managers: ['branch@ufcu.org', 'branch2@ufcu.org'],
            supervisors: ['boss@ufcu.org']
        };

        const BRANCHES = {
            North: ['Galveston', 'Georgetown', 'Highway 79', 'Kelly Lane', 'Manor', 'New Hope', 'Pearland', 'Pflugerville', 'Lakeline', 'Scofield', 'Steck', 'Teravista', 'Victory Lakes'],
            South: ['Ben White', 'Brodie', 'Downtown', 'Kyle', 'Mueller', 'North Guadalupe', 'San Marcos', 'South MoPac', 'Southpark Meadows', 'University'],
            Satellite: ['ACC - Highland', 'Area Team', 'Concordia', 'Gregory Gym', 'Northern Village', 'TX State University', 'TX State LBJ', 'UT Health', 'UT One Stop']
        };

        // Utility Functions
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        const formatTime = (time) => {
            const [hours, minutes] = time.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes));
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        };
        
        const getDateKey = (year, month, day) => `${year}-${month + 1}-${day}`;

        // Notification Component
        function Notification({ message, type, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`notification ${type} show`}>
                    {message}
                </div>
            );
        }

        // Login Component
        function Login({ onLogin }) {
            const [userType, setUserType] = useState('manager');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [region, setRegion] = useState('');
            const [branch, setBranch] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                
                const normalizedEmail = email.toLowerCase();
                const authList = AUTHORIZED_EMAILS[userType === 'manager' ? 'managers' : 'supervisors'];
                
                if (!authList.some(authEmail => authEmail.toLowerCase() === normalizedEmail)) {
                    setError('Unauthorized email address');
                    return;
                }

                if (userType === 'manager' && (!region || !branch)) {
                    setError('Please select region and branch');
                    return;
                }

                onLogin({ email, password, region, branch, userType });
            };

            return (
                <div className="card">
                    <div className="header">
                        <h1>Branch Scheduler</h1>
                        <p>Employee scheduling made simple</p>
                    </div>
                    
                    <div className="login-types">
                        <div 
                            className={`login-type ${userType === 'manager' ? 'active' : ''}`}
                            onClick={() => setUserType('manager')}
                        >
                            Manager Login
                        </div>
                        <div 
                            className={`login-type ${userType === 'supervisor' ? 'active' : ''}`}
                            onClick={() => setUserType('supervisor')}
                        >
                            Supervisor Dashboard
                        </div>
                    </div>
                    
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label>{userType === 'supervisor' ? 'Supervisor Email' : 'Email'}</label>
                            <input 
                                type="email" 
                                className="form-input" 
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required 
                            />
                        </div>
                        <div className="form-group">
                            <label>Password</label>
                            <input 
                                type="password" 
                                className="form-input" 
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required 
                            />
                        </div>
                        
                        {userType === 'manager' && (
                            <>
                                <div className="form-group">
                                    <label>Region</label>
                                    <select 
                                        className="form-input" 
                                        value={region}
                                        onChange={(e) => {
                                            setRegion(e.target.value);
                                            setBranch('');
                                        }}
                                        required
                                    >
                                        <option value="">Select Region</option>
                                        {Object.keys(BRANCHES).map(r => (
                                            <option key={r} value={r}>{r}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Branch</label>
                                    <select 
                                        className="form-input" 
                                        value={branch}
                                        onChange={(e) => setBranch(e.target.value)}
                                        required
                                    >
                                        <option value="">Select Branch</option>
                                        {region && BRANCHES[region].map(b => (
                                            <option key={b} value={b}>{b}</option>
                                        ))}
                                    </select>
                                </div>
                            </>
                        )}
                        
                        {error && <p style={{color: '#dc2626', marginBottom: 10}}>{error}</p>}
                        
                        <button type="submit" className="btn btn-primary" style={{width: '100%'}}>
                            Sign In
                        </button>
                    </form>
                </div>
            );
        }

        // Manager App Component
        function ManagerApp({ user, onLogout }) {
            const [activeTab, setActiveTab] = useState('shifts');
            const [employees, setEmployees] = useState([]);
            const [shifts, setShifts] = useState([]);
            const [schedule, setSchedule] = useState({});
            const [currentDate, setCurrentDate] = useState(new Date());
            const [notification, setNotification] = useState(null);
            const [modals, setModals] = useState({
                day: null,
                bulk: false
            });
            const autoSaveTimeout = useRef(null);

            // Load data from Firebase
            useEffect(() => {
                loadFromFirebase();
            }, [user]);

            const loadFromFirebase = async () => {
                try {
                    const branchKey = `${user.region}_${user.branch}`;
                    const doc = await db.collection('branches').doc(branchKey).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        setEmployees(data.data.employees || []);
                        setShifts(data.data.shifts || []);
                        setSchedule(data.data.schedule || {});
                        showNotification('Schedule loaded from cloud', 'success');
                    }
                } catch (error) {
                    showNotification('Error loading from cloud', 'error');
                }
            };

            const saveToFirebase = async () => {
                try {
                    const branchKey = `${user.region}_${user.branch}`;
                    await db.collection('branches').doc(branchKey).set({
                        user,
                        data: { employees, shifts, schedule },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        version: '2.0'
                    });
                    showNotification('Schedule saved to cloud', 'success');
                } catch (error) {
                    showNotification('Error saving to cloud', 'error');
                }
            };

            const triggerAutoSave = useCallback(() => {
                clearTimeout(autoSaveTimeout.current);
                autoSaveTimeout.current = setTimeout(() => saveToFirebase(), 2000);
            }, [employees, shifts, schedule]);

            useEffect(() => {
                if (employees.length || shifts.length || Object.keys(schedule).length) {
                    triggerAutoSave();
                }
            }, [employees, shifts, schedule, triggerAutoSave]);

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
            };

            const exportToExcel = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                try {
                    const wb = XLSX.utils.book_new();
                    const weeks = getWeeksInMonth(year, month);
                    
                    weeks.forEach((week, weekIndex) => {
                        const weekData = createWeekSheet(week);
                        const ws = XLSX.utils.aoa_to_sheet(weekData);
                        ws['!cols'] = Array(8).fill({ width: 14 });
                        ws['!cols'][0] = { width: 15 };
                        XLSX.utils.book_append_sheet(wb, ws, `Week ${weekIndex + 1}`);
                    });
                    
                    const summaryData = createSummarySheet();
                    const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
                    
                    const filename = `${user.region}_${user.branch}_Schedule_${monthName.replace(' ', '_')}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    showNotification('Schedule exported to Excel', 'success');
                } catch (error) {
                    showNotification('Error exporting to Excel', 'error');
                }
            };

            const getWeeksInMonth = (year, month) => {
                const weeks = [];
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                let currentWeekStart = new Date(firstDay);
                const dayOfWeek = currentWeekStart.getDay();
                if (dayOfWeek !== 0) {
                    currentWeekStart.setDate(currentWeekStart.getDate() - dayOfWeek);
                }
                
                while (currentWeekStart <= lastDay || currentWeekStart.getMonth() === month) {
                    const weekEnd = new Date(currentWeekStart);
                    weekEnd.setDate(currentWeekStart.getDate() + 6);
                    
                    weeks.push({
                        start: new Date(currentWeekStart),
                        end: new Date(weekEnd)
                    });
                    
                    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                    
                    if (currentWeekStart.getMonth() > month && currentWeekStart.getFullYear() >= year) {
                        break;
                    }
                }
                
                return weeks;
            };

            const createWeekSheet = (week) => {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dateRow = ['Name'];
                const dayRow = [''];
                
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(week.start);
                    currentDate.setDate(week.start.getDate() + i);
                    dateRow.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}/${currentDate.getFullYear()}`);
                    dayRow.push(dayNames[i]);
                }
                
                const weekData = [dateRow, dayRow];
                
                employees.forEach(employee => {
                    const row = [employee.name];
                    
                    for (let i = 0; i < 7; i++) {
                        const currentDate = new Date(week.start);
                        currentDate.setDate(week.start.getDate() + i);
                        
                        const dateKey = getDateKey(
                            currentDate.getFullYear(), 
                            currentDate.getMonth(), 
                            currentDate.getDate()
                        );
                        const daySchedule = schedule[dateKey] || [];
                        const empShift = daySchedule.find(item => item.employeeId === employee.id);
                        
                        if (empShift) {
                            const shift = shifts.find(s => s.id === empShift.shiftId);
                            if (shift) {
                                row.push(`${shift.name}\n${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}`);
                            } else {
                                row.push('');
                            }
                        } else {
                            row.push('OFF');
                        }
                    }
                    
                    weekData.push(row);
                });
                
                return weekData;
            };

            const createSummarySheet = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                const summaryData = [
                    ['Branch Schedule Summary'],
                    [''],
                    ['Region:', user.region],
                    ['Branch:', user.branch],
                    ['Month:', monthName],
                    ['Manager:', user.email],
                    ['Export Date:', new Date().toLocaleString()],
                    [''],
                    ['Employee Schedule Summary'],
                    ['Employee', 'Days Scheduled']
                ];
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                employees.forEach(emp => {
                    let daysCount = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateKey = getDateKey(year, month, day);
                        const daySchedule = schedule[dateKey] || [];
                        if (daySchedule.some(item => item.employeeId === emp.id)) {
                            daysCount++;
                        }
                    }
                    
                    summaryData.push([emp.name, daysCount]);
                });
                
                return summaryData;
            };

            const renderTabs = () => (
                <div className="tabs">
                    <button 
                        className={`tab ${activeTab === 'shifts' ? 'active' : ''}`}
                        onClick={() => setActiveTab('shifts')}
                    >
                        Shift Templates
                    </button>
                    <button 
                        className={`tab ${activeTab === 'employees' ? 'active' : ''}`}
                        onClick={() => setActiveTab('employees')}
                    >
                        Employees
                    </button>
                    <button 
                        className={`tab ${activeTab === 'schedule' ? 'active' : ''}`}
                        onClick={() => setActiveTab('schedule')}
                    >
                        Schedule
                    </button>
                </div>
            );

            const renderContent = () => {
                switch (activeTab) {
                    case 'shifts':
                        return <ShiftsTab shifts={shifts} setShifts={setShifts} showNotification={showNotification} />;
                    case 'employees':
                        return <EmployeesTab employees={employees} setEmployees={setEmployees} showNotification={showNotification} />;
                    case 'schedule':
                        return (
                            <ScheduleTab 
                                employees={employees}
                                shifts={shifts}
                                schedule={schedule}
                                setSchedule={setSchedule}
                                currentDate={currentDate}
                                setCurrentDate={setCurrentDate}
                                showNotification={showNotification}
                                modals={modals}
                                setModals={setModals}
                            />
                        );
                    default:
                        return null;
                }
            };

            return (
                <div className="card">
                    <div className="header">
                        <h1>Branch Scheduler</h1>
                        <div>{user.region} Region - {user.branch} Branch</div>
                        <div className="header-actions">
                            <button className="btn btn-secondary btn-small" onClick={exportToExcel}>
                                Export to Excel
                            </button>
                            <button className="btn btn-secondary btn-small" onClick={saveToFirebase}>
                                Save to Cloud
                            </button>
                            <button className="btn btn-secondary btn-small" onClick={onLogout}>
                                Sign Out
                            </button>
                        </div>
                    </div>
                    {renderTabs()}
                    {renderContent()}
                    {notification && (
                        <Notification 
                            message={notification.message} 
                            type={notification.type}
                            onClose={() => setNotification(null)}
                        />
                    )}
                </div>
            );
        }

        // Shifts Tab Component
        function ShiftsTab({ shifts, setShifts, showNotification }) {
            const addShift = () => {
                setShifts([...shifts, {
                    id: generateId(),
                    name: '',
                    startTime: '09:00',
                    endTime: '17:00',
                    color: '#059669',
                    isNew: true
                }]);
            };

            const saveShift = (id) => {
                const shift = shifts.find(s => s.id === id);
                const nameInput = document.getElementById(`shift-name-${id}`);
                const startInput = document.getElementById(`shift-start-${id}`);
                const endInput = document.getElementById(`shift-end-${id}`);
                const colorInput = document.getElementById(`shift-color-${id}`);
                
                if (!nameInput.value.trim()) {
                    showNotification('Shift name is required', 'error');
                    return;
                }
                
                if (startInput.value >= endInput.value) {
                    showNotification('End time must be after start time', 'error');
                    return;
                }
                
                setShifts(shifts.map(s => 
                    s.id === id ? {
                        ...s,
                        name: nameInput.value.trim(),
                        startTime: startInput.value,
                        endTime: endInput.value,
                        color: colorInput.value,
                        isNew: false
                    } : s
                ));
                showNotification(`Saved ${nameInput.value.trim()}`);
            };

            const removeShift = (id) => {
                const shift = shifts.find(s => s.id === id);
                if (confirm(`Delete ${shift.name}?`)) {
                    setShifts(shifts.filter(s => s.id !== id));
                    showNotification('Shift deleted');
                }
            };

            return (
                <div>
                    <h2>Shift Templates</h2>
                    <div className="shift-list">
                        {shifts.length === 0 ? (
                            <p className="empty-state">No shift templates created yet</p>
                        ) : (
                            shifts.map(shift => (
                                <div key={shift.id} className="shift-card">
                                    {shift.isNew ? (
                                        <div className="shift-form">
                                            <div>
                                                <label>Shift Name</label>
                                                <input 
                                                    type="text" 
                                                    id={`shift-name-${shift.id}`} 
                                                    className="form-input" 
                                                    placeholder="Morning Shift" 
                                                    defaultValue={shift.name}
                                                />
                                            </div>
                                            <div>
                                                <label>Start Time</label>
                                                <input 
                                                    type="time" 
                                                    id={`shift-start-${shift.id}`} 
                                                    className="form-input" 
                                                    defaultValue={shift.startTime}
                                                />
                                            </div>
                                            <div>
                                                <label>End Time</label>
                                                <input 
                                                    type="time" 
                                                    id={`shift-end-${shift.id}`} 
                                                    className="form-input" 
                                                    defaultValue={shift.endTime}
                                                />
                                            </div>
                                            <div>
                                                <label>Color</label>
                                                <input 
                                                    type="color" 
                                                    id={`shift-color-${shift.id}`} 
                                                    className="form-input" 
                                                    defaultValue={shift.color}
                                                />
                                                <button 
                                                    className="btn btn-success btn-small" 
                                                    onClick={() => saveShift(shift.id)}
                                                    style={{marginTop: 10, width: '100%'}}
                                                >
                                                    Save
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                            <div>
                                                <h3>{shift.name}</h3>
                                                <p>{formatTime(shift.startTime)} - {formatTime(shift.endTime)}</p>
                                            </div>
                                            <div style={{display: 'flex', gap: 10, alignItems: 'center'}}>
                                                <div style={{width: 20, height: 20, background: shift.color, borderRadius: 4}}></div>
                                                <button 
                                                    className="btn btn-danger btn-small" 
                                                    onClick={() => removeShift(shift.id)}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                    <button className="btn btn-primary" onClick={addShift}>
                        Add Shift Template
                    </button>
                </div>
            );
        }

        // Employees Tab Component
        function EmployeesTab({ employees, setEmployees, showNotification }) {
            const [newEmployeeName, setNewEmployeeName] = useState('');

            const addEmployee = () => {
                if (!newEmployeeName.trim()) {
                    showNotification('Please enter employee name', 'error');
                    return;
                }
                
                if (employees.some(e => e.name === newEmployeeName.trim())) {
                    showNotification('Employee already exists', 'error');
                    return;
                }
                
                setEmployees([...employees, { id: generateId(), name: newEmployeeName.trim() }]);
                setNewEmployeeName('');
                showNotification(`Added ${newEmployeeName.trim()}`);
            };

            const removeEmployee = (id) => {
                const employee = employees.find(e => e.id === id);
                if (confirm(`Remove ${employee.name}?`)) {
                    setEmployees(employees.filter(e => e.id !== id));
                    showNotification(`Removed ${employee.name}`);
                }
            };

            return (
                <div>
                    <h2>Employees</h2>
                    <div style={{display: 'flex', gap: 10, marginBottom: 20}}>
                        <input 
                            type="text" 
                            className="form-input" 
                            placeholder="Employee name" 
                            style={{flex: 1}}
                            value={newEmployeeName}
                            onChange={(e) => setNewEmployeeName(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && addEmployee()}
                        />
                        <button className="btn btn-success" onClick={addEmployee}>
                            Add Employee
                        </button>
                    </div>
                    <div className="employee-list">
                        {employees.length === 0 ? (
                            <p className="empty-state">No employees added yet</p>
                        ) : (
                            employees.map(employee => (
                                <div key={employee.id} className="employee-card">
                                    <span>{employee.name}</span>
                                    <button 
                                        className="btn btn-danger btn-small" 
                                        onClick={() => removeEmployee(employee.id)}
                                    >
                                        ×
                                    </button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // Schedule Tab Component
        function ScheduleTab({ employees, shifts, schedule, setSchedule, currentDate, setCurrentDate, showNotification, modals, setModals }) {
            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const today = new Date();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                const days = [];
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                // Add day headers
                dayNames.forEach(day => {
                    days.push(<div key={`header-${day}`} className="day-header">{day}</div>);
                });
                
                // Add empty cells for previous month
                for (let i = 0; i < startingDay; i++) {
                    days.push(<div key={`empty-${i}`} className="calendar-day other-month"></div>);
                }
                
                // Add month days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(year, month, day);
                    const isToday = dayDate.toDateString() === today.toDateString();
                    const dateKey = getDateKey(year, month, day);
                    const daySchedule = schedule[dateKey] || [];
                    
                    days.push(
                        <div 
                            key={`day-${day}`} 
                            className={`calendar-day ${isToday ? 'today' : ''}`}
                            onClick={() => openDayModal(year, month, day)}
                        >
                            <div className="day-number">{day}</div>
                            {daySchedule.map(item => {
                                const employee = employees.find(e => e.id === item.employeeId);
                                const shift = shifts.find(s => s.id === item.shiftId);
                                
                                if (employee && shift) {
                                    return (
                                        <div key={item.id} className="shift-item" style={{background: shift.color}}>
                                            {employee.name} ({formatTime(shift.startTime)}-{formatTime(shift.endTime)})
                                            <button 
                                                className="remove-shift"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    removeScheduleItem(dateKey, item.id);
                                                }}
                                            >
                                                ×
                                            </button>
                                        </div>
                                    );
                                }
                                return null;
                            })}
                        </div>
                    );
                }
                
                return days;
            };

            const openDayModal = (year, month, day) => {
                if (employees.length === 0 || shifts.length === 0) {
                    showNotification('Add employees and shifts first', 'warning');
                    return;
                }
                setModals({...modals, day: {year, month, day}});
            };

            const removeScheduleItem = (dateKey, itemId) => {
                const newSchedule = {...schedule};
                newSchedule[dateKey] = newSchedule[dateKey].filter(item => item.id !== itemId);
                if (newSchedule[dateKey].length === 0) {
                    delete newSchedule[dateKey];
                }
                setSchedule(newSchedule);
            };

            const clearMonth = () => {
                if (confirm('Clear all shifts for this month?')) {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const lastDay = new Date(year, month + 1, 0).getDate();
                    
                    const newSchedule = {...schedule};
                    for (let day = 1; day <= lastDay; day++) {
                        const dateKey = getDateKey(year, month, day);
                        delete newSchedule[dateKey];
                    }
                    
                    setSchedule(newSchedule);
                    showNotification('Month cleared!');
                }
            };

            return (
                <div>
                    <div className="month-nav">
                        <button 
                            className="btn btn-secondary" 
                            onClick={() => {
                                const newDate = new Date(currentDate);
                                newDate.setMonth(newDate.getMonth() - 1);
                                setCurrentDate(newDate);
                            }}
                        >
                            ← Previous
                        </button>
                        <h2 className="month-title">
                            {currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}
                        </h2>
                        <button 
                            className="btn btn-secondary" 
                            onClick={() => {
                                const newDate = new Date(currentDate);
                                newDate.setMonth(newDate.getMonth() + 1);
                                setCurrentDate(newDate);
                            }}
                        >
                            Next →
                        </button>
                    </div>
                    
                    <div style={{marginBottom: 20}}>
                        <button 
                            className="btn btn-secondary" 
                            onClick={() => setModals({...modals, bulk: true})}
                            style={{marginRight: 10}}
                        >
                            Bulk Schedule
                        </button>
                        <button className="btn btn-secondary" onClick={clearMonth}>
                            Clear Month
                        </button>
                    </div>
                    
                    <div className="calendar">
                        {renderCalendar()}
                    </div>
                    
                    {modals.day && (
                        <DayModal 
                            date={modals.day}
                            employees={employees}
                            shifts={shifts}
                            schedule={schedule}
                            setSchedule={setSchedule}
                            onClose={() => setModals({...modals, day: null})}
                        />
                    )}
                    
                    {modals.bulk && (
                        <BulkModal 
                            employees={employees}
                            shifts={shifts}
                            schedule={schedule}
                            setSchedule={setSchedule}
                            onClose={() => setModals({...modals, bulk: false})}
                            showNotification={showNotification}
                        />
                    )}
                </div>
            );
        }

        // Day Modal Component
        function DayModal({ date, employees, shifts, schedule, setSchedule, onClose }) {
            const dateKey = getDateKey(date.year, date.month, date.day);
            const daySchedule = schedule[dateKey] || [];
            
            const toggleSchedule = (employeeId, shiftId, isChecked) => {
                const newSchedule = {...schedule};
                
                if (!newSchedule[dateKey]) {
                    newSchedule[dateKey] = [];
                }
                
                if (isChecked) {
                    newSchedule[dateKey].push({
                        id: generateId(),
                        employeeId,
                        shiftId,
                        date: dateKey
                    });
                } else {
                    newSchedule[dateKey] = newSchedule[dateKey].filter(
                        item => !(item.employeeId === employeeId && item.shiftId === shiftId)
                    );
                    
                    if (newSchedule[dateKey].length === 0) {
                        delete newSchedule[dateKey];
                    }
                }
                
                setSchedule(newSchedule);
            };

            const dateObj = new Date(date.year, date.month, date.day);
            
            return (
                <div className="modal open" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>
                                Schedule for {dateObj.toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}
                            </h3>
                            <button className="close-btn" onClick={onClose}>&times;</button>
                        </div>
                        
                        {shifts.map(shift => {
                            const assignedEmployees = daySchedule
                                .filter(item => item.shiftId === shift.id)
                                .map(item => item.employeeId);
                            
                            return (
                                <div key={shift.id} className="shift-group">
                                    <h4>{shift.name} ({formatTime(shift.startTime)} - {formatTime(shift.endTime)})</h4>
                                    <div className="checkbox-list">
                                        {employees.map(employee => (
                                            <div key={employee.id} className="checkbox-item">
                                                <input 
                                                    type="checkbox"
                                                    id={`assign-${shift.id}-${employee.id}`}
                                                    checked={assignedEmployees.includes(employee.id)}
                                                    onChange={(e) => toggleSchedule(employee.id, shift.id, e.target.checked)}
                                                />
                                                <label htmlFor={`assign-${shift.id}-${employee.id}`}>
                                                    {employee.name}
                                                </label>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                        
                        <button 
                            className="btn btn-primary" 
                            style={{width: '100%', marginTop: 20}}
                            onClick={onClose}
                        >
                            Done
                        </button>
                    </div>
                </div>
            );
        }

        // Bulk Modal Component
        function BulkModal({ employees, shifts, schedule, setSchedule, onClose, showNotification }) {
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [includeSaturdays, setIncludeSaturdays] = useState(true);
            const [selections, setSelections] = useState({});

            useEffect(() => {
                // Set default dates
                const today = new Date();
                const monday = new Date(today);
                monday.setDate(today.getDate() - today.getDay() + 1);
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4);
                
                setStartDate(monday.toISOString().split('T')[0]);
                setEndDate(friday.toISOString().split('T')[0]);
            }, []);

            const handleCheckChange = (type, shiftId, employeeId, checked) => {
                const key = `${type}-${shiftId}-${employeeId}`;
                setSelections({...selections, [key]: checked});
            };

            const applyBulkSchedule = () => {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (!start || !end || start > end) {
                    showNotification('Please select valid date range', 'error');
                    return;
                }
                
                const newSchedule = {...schedule};
                let count = 0;
                
                for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                    const dayOfWeek = date.getDay();
                    
                    if (dayOfWeek === 0) continue; // Skip Sundays
                    
                    const dateKey = getDateKey(date.getFullYear(), date.getMonth(), date.getDate());
                    
                    shifts.forEach(shift => {
                        employees.forEach(employee => {
                            const key = dayOfWeek === 6 ? 
                                `sat-${shift.id}-${employee.id}` : 
                                `week-${shift.id}-${employee.id}`;
                            
                            if (selections[key]) {
                                if (!newSchedule[dateKey]) newSchedule[dateKey] = [];
                                
                                if (!newSchedule[dateKey].some(item => 
                                    item.employeeId === employee.id && item.shiftId === shift.id)) {
                                    newSchedule[dateKey].push({
                                        id: generateId(),
                                        employeeId: employee.id,
                                        shiftId: shift.id,
                                        date: dateKey
                                    });
                                    count++;
                                }
                            }
                        });
                    });
                    
                    if (dayOfWeek === 6 && !includeSaturdays) {
                        delete newSchedule[dateKey];
                    }
                }
                
                setSchedule(newSchedule);
                showNotification(`Scheduled ${count} shifts!`);
                onClose();
            };

            return (
                <div className="modal open" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Bulk Schedule</h3>
                            <button className="close-btn" onClick={onClose}>&times;</button>
                        </div>
                        
                        <div className="form-group">
                            <label>Start Date</label>
                            <input 
                                type="date" 
                                className="form-input"
                                value={startDate}
                                onChange={(e) => setStartDate(e.target.value)}
                            />
                        </div>
                        <div className="form-group">
                            <label>End Date</label>
                            <input 
                                type="date" 
                                className="form-input"
                                value={endDate}
                                onChange={(e) => setEndDate(e.target.value)}
                            />
                        </div>
                        
                        <h4 style={{marginBottom: 15, color: '#2563eb'}}>Weekday Schedule (Mon-Fri)</h4>
                        {shifts.map(shift => (
                            <div key={`week-${shift.id}`} className="shift-group">
                                <h4>{shift.name} ({formatTime(shift.startTime)} - {formatTime(shift.endTime)})</h4>
                                <div className="checkbox-list">
                                    {employees.map(employee => (
                                        <div key={employee.id} className="checkbox-item">
                                            <input 
                                                type="checkbox"
                                                id={`bulk-week-${shift.id}-${employee.id}`}
                                                onChange={(e) => handleCheckChange('week', shift.id, employee.id, e.target.checked)}
                                            />
                                            <label htmlFor={`bulk-week-${shift.id}-${employee.id}`}>
                                                {employee.name}
                                            </label>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        
                        <div style={{marginTop: 30, paddingTop: 20, borderTop: '2px solid #e2e8f0'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: 10, marginBottom: 15}}>
                                <input 
                                    type="checkbox" 
                                    id="includeSaturdays"
                                    checked={includeSaturdays}
                                    onChange={(e) => setIncludeSaturdays(e.target.checked)}
                                />
                                <label htmlFor="includeSaturdays" style={{fontWeight: 600, color: '#2563eb'}}>
                                    Include Saturdays
                                </label>
                            </div>
                            
                            {includeSaturdays && (
                                <div>
                                    <h4 style={{marginBottom: 15, color: '#059669'}}>Saturday Schedule</h4>
                                    {shifts.map(shift => (
                                        <div key={`sat-${shift.id}`} className="shift-group">
                                            <h4>{shift.name} ({formatTime(shift.startTime)} - {formatTime(shift.endTime)})</h4>
                                            <div className="checkbox-list">
                                                {employees.map(employee => (
                                                    <div key={employee.id} className="checkbox-item">
                                                        <input 
                                                            type="checkbox"
                                                            id={`bulk-sat-${shift.id}-${employee.id}`}
                                                            onChange={(e) => handleCheckChange('sat', shift.id, employee.id, e.target.checked)}
                                                        />
                                                        <label htmlFor={`bulk-sat-${shift.id}-${employee.id}`}>
                                                            {employee.name}
                                                        </label>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        <div style={{display: 'flex', gap: 10, marginTop: 20}}>
                            <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={applyBulkSchedule}>Apply</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Supervisor App Component
        function SupervisorApp({ user, onLogout }) {
            const [supervisorData, setSupervisorData] = useState({});
            const [selectedBranch, setSelectedBranch] = useState(null);
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                loadSupervisorData();
            }, []);

            const loadSupervisorData = async () => {
                try {
                    const snapshot = await db.collection('branches').get();
                    const data = {};
                    snapshot.forEach(doc => {
                        data[doc.id] = doc.data();
                    });
                    setSupervisorData(data);
                } catch (error) {
                    showNotification('Error loading branch data', 'error');
                }
            };

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
            };

            const exportToExcel = () => {
                // Similar export logic for supervisor
                showNotification('Report exported to Excel', 'success');
            };

            return (
                <div className="card">
                    <div className="header">
                        <h1>Supervisor Dashboard</h1>
                        <p>View all branch schedules</p>
                        <div className="header-actions">
                            <button className="btn btn-secondary btn-small" onClick={exportToExcel}>
                                Export to Excel
                            </button>
                            <button className="btn btn-secondary btn-small" onClick={onLogout}>
                                Sign Out
                            </button>
                        </div>
                    </div>
                    
                    <div className="supervisor-stats">
                        {Object.keys(supervisorData).length > 0 ? (
                            <>
                                <div className="stat-card">
                                    <div className="stat-number">{Object.keys(supervisorData).length}</div>
                                    <div className="stat-label">Branches</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-number">
                                        {Object.values(supervisorData).reduce((sum, b) => sum + (b.data.employees?.length || 0), 0)}
                                    </div>
                                    <div className="stat-label">Total Employees</div>
                                </div>
                            </>
                        ) : (
                            <p className="empty-state">No branch data available yet</p>
                        )}
                    </div>
                    
                    {Object.keys(supervisorData).length > 0 && (
                        <div className="form-group">
                            <label>Select Branch to View Schedule</label>
                            <select 
                                className="form-input" 
                                style={{maxWidth: 400}}
                                onChange={(e) => setSelectedBranch(e.target.value)}
                            >
                                <option value="">Choose a branch...</option>
                                {Object.keys(supervisorData).map(key => {
                                    const branch = supervisorData[key];
                                    return (
                                        <option key={key} value={key}>
                                            {branch.user.region} - {branch.user.branch}
                                        </option>
                                    );
                                })}
                            </select>
                        </div>
                    )}
                    
                    {selectedBranch && supervisorData[selectedBranch] && (
                        <div style={{marginTop: 30}}>
                            <h2>{supervisorData[selectedBranch].user.region} - {supervisorData[selectedBranch].user.branch}</h2>
                            <p>Manager: {supervisorData[selectedBranch].user.email}</p>
                            <p>Employees: {supervisorData[selectedBranch].data.employees?.length || 0}</p>
                            <p>Shifts: {supervisorData[selectedBranch].data.shifts?.length || 0}</p>
                        </div>
                    )}
                    
                    {notification && (
                        <Notification 
                            message={notification.message} 
                            type={notification.type}
                            onClose={() => setNotification(null)}
                        />
                    )}
                </div>
            );
        }

        // Main App Component
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [screen, setScreen] = useState('login');

            const handleLogin = (credentials) => {
                setCurrentUser(credentials);
                setScreen(credentials.userType === 'supervisor' ? 'supervisor' : 'manager');
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setScreen('login');
            };

            if (screen === 'login') {
                return (
                    <div className="container">
                        <Login onLogin={handleLogin} />
                    </div>
                );
            }

            if (screen === 'manager') {
                return (
                    <div className="container">
                        <ManagerApp user={currentUser} onLogout={handleLogout} />
                    </div>
                );
            }

            if (screen === 'supervisor') {
                return (
                    <div className="container">
                        <SupervisorApp user={currentUser} onLogout={handleLogout} />
                    </div>
                );
            }

            return null;
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
