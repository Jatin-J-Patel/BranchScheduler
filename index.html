<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Employee Scheduler</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            margin: -30px -30px 30px -30px;
        }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header-actions { display: flex; gap: 10px; margin-top: 15px; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-secondary { background: #e2e8f0; color: #334155; }
        .btn-success { background: #059669; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn:hover { transform: translateY(-1px); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
        }
        .form-input:focus { border-color: #2563eb; outline: none; }
        
        .tabs { display: flex; background: #f1f5f9; border-radius: 8px; margin-bottom: 30px; }
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
        }
        .tab.active { background: #2563eb; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .employee-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .shift-list { margin-bottom: 30px; }
        .shift-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            margin-bottom: 15px;
        }
        .shift-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            cursor: pointer;
            position: relative;
        }
        .calendar-day:hover { background: #f8fafc; }
        .calendar-day.today { background: #fef3c7; }
        .calendar-day.other-month { background: #f1f5f9; opacity: 0.6; }
        .day-header {
            background: #2563eb;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        .day-number { font-weight: 700; margin-bottom: 8px; }
        .shift-item {
            background: #059669;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 4px;
            position: relative;
        }
        .shift-item:hover .remove-shift { display: block; }
        .remove-shift {
            display: none;
            position: absolute;
            top: -6px;
            right: -6px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        
        .shift-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        .checkbox-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #059669; }
        .notification.error { background: #dc2626; }
        .notification.warning { background: #d97706; }
        
        .hidden { display: none !important; }
        
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .month-title { font-size: 24px; font-weight: 600; }
        
        .login-types { display: flex; gap: 10px; margin-bottom: 20px; }
        .login-type {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
        }
        .login-type.active {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
        }
        
        .supervisor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number { font-size: 24px; font-weight: 700; color: #2563eb; }
        .stat-label { font-size: 14px; color: #64748b; margin-top: 5px; }
        
        @media (max-width: 768px) {
            .shift-form { grid-template-columns: 1fr; }
            .calendar-day { min-height: 100px; font-size: 12px; }
            .checkbox-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="card">
            <div class="header">
                <h1>Branch Scheduler</h1>
                <p>Employee scheduling made simple</p>
            </div>
            
            <div class="login-types">
                <div class="login-type active" data-type="manager">Manager Login</div>
                <div class="login-type" data-type="supervisor">Supervisor Dashboard</div>
            </div>
            
            <form id="loginForm">
                <div id="managerFields">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="password" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <select id="region" class="form-input" required>
                            <option value="">Select Region</option>
                            <option value="North">North</option>
                            <option value="South">South</option>
                            <option value="Satellite">Satellite</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Branch</label>
                        <select id="branch" class="form-input" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                </div>

                <div id="supervisorFields" class="hidden">
                    <div class="form-group">
                        <label>Supervisor Email</label>
                        <input type="email" id="supervisorEmail" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="supervisorPassword" class="form-input">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
            </form>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <div class="card">
                <div class="header">
                    <h1>Branch Scheduler</h1>
                    <div id="branchInfo">Loading...</div>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-small" id="exportBtn">Export to Excel</button>
                        <button class="btn btn-secondary btn-small" id="saveBtn">Save to Cloud</button>
                        <button class="btn btn-secondary btn-small" id="logoutBtn">Sign Out</button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="shifts">Shift Templates</button>
                    <button class="tab" data-tab="employees">Employees</button>
                    <button class="tab" data-tab="schedule">Schedule</button>
                </div>

                <!-- Tabs Content -->
                <div class="tab-content active" id="shiftsTab">
                    <h2>Shift Templates</h2>
                    <div id="shiftList" class="shift-list"></div>
                    <button class="btn btn-primary" id="addShiftBtn">Add Shift Template</button>
                </div>

                <div class="tab-content" id="employeesTab">
                    <h2>Employees</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="newEmployeeName" class="form-input" placeholder="Employee name" style="flex: 1;">
                        <button class="btn btn-success" id="addEmployeeBtn">Add Employee</button>
                    </div>
                    <div id="employeeList" class="employee-list"></div>
                </div>

                <div class="tab-content" id="scheduleTab">
                    <div class="month-nav">
                        <button class="btn btn-secondary" id="prevMonthBtn">← Previous</button>
                        <h2 class="month-title" id="monthTitle">January 2024</h2>
                        <button class="btn btn-secondary" id="nextMonthBtn">Next →</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" id="bulkBtn">Bulk Schedule</button>
                        <button class="btn btn-secondary" id="clearBtn">Clear Month</button>
                    </div>
                    
                    <div class="calendar" id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- Supervisor App -->
        <div id="supervisorApp" class="hidden">
            <div class="card">
                <div class="header">
                    <h1>Supervisor Dashboard</h1>
                    <p>View all branch schedules</p>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-small" id="supervisorExportBtn">Export to Excel</button>
                        <button class="btn btn-secondary btn-small" id="supervisorLogoutBtn">Sign Out</button>
                    </div>
                </div>

                <div id="supervisorStats" class="supervisor-stats"></div>
                
                <div id="branchSelector" class="hidden" style="margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Select Branch to View Schedule</label>
                        <select id="branchDropdown" class="form-input" style="max-width: 400px;">
                            <option value="">Choose a branch...</option>
                        </select>
                    </div>
                </div>
                
                <div id="supervisorContent"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="dayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="dayModalTitle">Schedule Day</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div id="dayModalContent"></div>
            <button class="btn btn-primary" id="dayModalDone" style="width: 100%; margin-top: 20px;">Done</button>
        </div>
    </div>

    <div class="modal" id="bulkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bulk Schedule</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="bulkStart" class="form-input">
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="bulkEnd" class="form-input">
            </div>
            <div id="bulkContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="bulkCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="bulkApplyBtn">Apply</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Initialize Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBxQ7geoG3DsmBRuM1dMM6SjUUXyUb5YtA",
            authDomain: "scheduler-8af78.firebaseapp.com",
            projectId: "scheduler-8af78",
            storageBucket: "scheduler-8af78.firebasestorage.app",
            messagingSenderId: "580854836199",
            appId: "1:580854836199:web:9d7dc1cdf9308c4cfd6b42",
            measurementId: "G-R6LDVHMBLY"
        });

        const db = firebase.firestore();
        const auth = firebase.auth();

        // Application State
        class App {
            constructor() {
                this.currentUser = null;
                this.userType = 'manager';
                this.currentDate = new Date();
                this.employees = [];
                this.shifts = [];
                this.schedule = {};
                this.supervisorData = {};
                this.selectedBranch = null;
                this.supervisorCurrentDate = null;
                this.autoSaveTimeout = null;
                
                this.authorizedEmails = {
                    managers: ['branch@ufcu.org', 'branch2@ufcu.org'],
                    supervisors: ['boss@ufcu.org']
                };
                
                this.branches = {
                    North: ['Galveston', 'Georgetown', 'Highway 79', 'Kelly Lane', 'Manor', 'New Hope', 'Pearland', 'Pflugerville', 'Lakeline', 'Scofield', 'Steck', 'Teravista', 'Victory Lakes'],
                    South: ['Ben White', 'Brodie', 'Downtown', 'Kyle', 'Mueller', 'North Guadalupe', 'San Marcos', 'South MoPac', 'Southpark Meadows', 'University'],
                    Satellite: ['ACC - Highland', 'Area Team', 'Concordia', 'Gregory Gym', 'Northern Village', 'TX State University', 'TX State LBJ', 'UT Health', 'UT One Stop']
                };
                
                this.init();
            }

            // Utility Methods
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            formatTime(time) {
                const [hours, minutes] = time.split(':');
                const date = new Date();
                date.setHours(parseInt(hours), parseInt(minutes));
                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }

            getDateKey(year, month, day) {
                return `${year}-${month + 1}-${day}`;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // Auth Methods
            isAuthorizedUser(email, type) {
                const normalizedEmail = email.toLowerCase();
                const authList = this.authorizedEmails[type === 'manager' ? 'managers' : 'supervisors'];
                return authList.some(authEmail => authEmail.toLowerCase() === normalizedEmail);
            }

            async login(email, password, region, branch) {
                try {
                    if (!this.isAuthorizedUser(email, this.userType)) {
                        this.showNotification('Unauthorized email address', 'error');
                        return;
                    }

                    this.currentUser = { email, region, branch, type: this.userType };
                    
                    if (this.userType === 'supervisor') {
                        this.showScreen('supervisor');
                        await this.loadSupervisorData();
                    } else {
                        this.showScreen('main');
                        await this.loadFromFirebase();
                        this.updateUI();
                    }
                    
                    this.showNotification('Login successful!');
                } catch (error) {
                    this.showNotification('Login failed', 'error');
                }
            }

            logout() {
                this.currentUser = null;
                this.employees = [];
                this.shifts = [];
                this.schedule = {};
                this.supervisorData = {};
                this.showScreen('login');
                this.showNotification('Logged out successfully', 'success');
            }

            showScreen(screen) {
                document.getElementById('loginScreen').classList.toggle('hidden', screen !== 'login');
                document.getElementById('mainApp').classList.toggle('hidden', screen !== 'main');
                document.getElementById('supervisorApp').classList.toggle('hidden', screen !== 'supervisor');
            }

            // Firebase Methods
            async saveToFirebase() {
                if (!this.currentUser || this.userType !== 'manager') return;
                
                try {
                    const branchKey = `${this.currentUser.region}_${this.currentUser.branch}`;
                    await db.collection('branches').doc(branchKey).set({
                        user: this.currentUser,
                        data: { employees: this.employees, shifts: this.shifts, schedule: this.schedule },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        version: '2.0'
                    });
                    this.showNotification('Schedule saved to cloud', 'success');
                } catch (error) {
                    this.showNotification('Error saving to cloud', 'error');
                }
            }

            async loadFromFirebase() {
                if (!this.currentUser || this.userType !== 'manager') return;
                
                try {
                    const branchKey = `${this.currentUser.region}_${this.currentUser.branch}`;
                    const doc = await db.collection('branches').doc(branchKey).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        this.employees = data.data.employees || [];
                        this.shifts = data.data.shifts || [];
                        this.schedule = data.data.schedule || {};
                        this.showNotification('Schedule loaded from cloud', 'success');
                    }
                } catch (error) {
                    this.showNotification('Error loading from cloud', 'error');
                }
            }

            async loadSupervisorData() {
                if (this.userType !== 'supervisor') return;
                
                try {
                    const snapshot = await db.collection('branches').get();
                    this.supervisorData = {};
                    snapshot.forEach(doc => {
                        this.supervisorData[doc.id] = doc.data();
                    });
                    this.renderSupervisorDashboard();
                } catch (error) {
                    this.showNotification('Error loading branch data', 'error');
                }
            }

            triggerAutoSave() {
                clearTimeout(this.autoSaveTimeout);
                this.autoSaveTimeout = setTimeout(() => this.saveToFirebase(), 2000);
            }

            // Employee Methods
            addEmployee(name) {
                if (!name.trim()) {
                    this.showNotification('Please enter employee name', 'error');
                    return;
                }
                
                if (this.employees.some(e => e.name === name)) {
                    this.showNotification('Employee already exists', 'error');
                    return;
                }
                
                this.employees.push({ id: this.generateId(), name: name.trim() });
                this.triggerAutoSave();
                this.renderEmployees();
                this.showNotification(`Added ${name}`);
            }

            removeEmployee(id) {
                const employee = this.employees.find(e => e.id === id);
                if (!employee || !confirm(`Remove ${employee.name}?`)) return;
                
                this.employees = this.employees.filter(e => e.id !== id);
                Object.keys(this.schedule).forEach(dateKey => {
                    this.schedule[dateKey] = this.schedule[dateKey].filter(shift => shift.employeeId !== id);
                    if (!this.schedule[dateKey].length) delete this.schedule[dateKey];
                });
                
                this.triggerAutoSave();
                this.renderEmployees();
                this.renderCalendar();
                this.showNotification(`Removed ${employee.name}`);
            }

            // Shift Methods
            addShift() {
                this.shifts.push({
                    id: this.generateId(),
                    name: '',
                    startTime: '09:00',
                    endTime: '17:00',
                    color: '#059669',
                    isNew: true
                });
                this.renderShifts();
            }

            saveShift(id) {
                const shift = this.shifts.find(s => s.id === id);
                if (!shift) return;
                
                const name = document.getElementById(`shift-name-${id}`).value.trim();
                const startTime = document.getElementById(`shift-start-${id}`).value;
                const endTime = document.getElementById(`shift-end-${id}`).value;
                const color = document.getElementById(`shift-color-${id}`).value;
                
                if (!name) {
                    this.showNotification('Shift name is required', 'error');
                    return;
                }
                
                if (startTime >= endTime) {
                    this.showNotification('End time must be after start time', 'error');
                    return;
                }
                
                Object.assign(shift, { name, startTime, endTime, color, isNew: false });
                this.triggerAutoSave();
                this.renderShifts();
                this.showNotification(`Saved ${name}`);
            }

            removeShift(id) {
                const shift = this.shifts.find(s => s.id === id);
                if (!shift || !confirm(`Delete ${shift.name}?`)) return;
                
                this.shifts = this.shifts.filter(s => s.id !== id);
                Object.keys(this.schedule).forEach(dateKey => {
                    this.schedule[dateKey] = this.schedule[dateKey].filter(s => s.shiftId !== id);
                    if (!this.schedule[dateKey].length) delete this.schedule[dateKey];
                });
                
                this.triggerAutoSave();
                this.renderShifts();
                this.renderCalendar();
                this.showNotification('Shift deleted');
            }

            // Schedule Methods
            toggleSchedule(dateKey, employeeId, shiftId, isChecked) {
                if (!this.schedule[dateKey]) this.schedule[dateKey] = [];
                
                if (isChecked) {
                    this.schedule[dateKey].push({
                        id: this.generateId(),
                        employeeId,
                        shiftId,
                        date: dateKey
                    });
                } else {
                    this.schedule[dateKey] = this.schedule[dateKey].filter(
                        item => !(item.employeeId === employeeId && item.shiftId === shiftId)
                    );
                    if (!this.schedule[dateKey].length) delete this.schedule[dateKey];
                }
                
                this.triggerAutoSave();
                this.renderCalendar();
            }

            removeScheduleItem(dateKey, itemId) {
                if (!this.schedule[dateKey]) return;
                
                this.schedule[dateKey] = this.schedule[dateKey].filter(item => item.id !== itemId);
                if (!this.schedule[dateKey].length) delete this.schedule[dateKey];
                
                this.triggerAutoSave();
                this.renderCalendar();
            }

            // Export Methods
            exportToExcel() {
                if (this.userType === 'supervisor') {
                    this.exportSupervisorToExcel();
                } else {
                    this.exportManagerToExcel();
                }
            }

            exportManagerToExcel() {
                try {
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth();
                    const monthName = this.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    
                    // Get all weeks in the month
                    const weeks = this.getWeeksInMonth(year, month);
                    
                    // Create a sheet for each week
                    weeks.forEach((week, weekIndex) => {
                        const weekData = this.createWeekSheet(week, weekIndex + 1);
                        const ws = XLSX.utils.aoa_to_sheet(weekData);
                        
                        // Set column widths
                        ws['!cols'] = [
                            { width: 15 }, // Name column
                            { width: 14 }, // Sunday
                            { width: 14 }, // Monday
                            { width: 14 }, // Tuesday
                            { width: 14 }, // Wednesday
                            { width: 14 }, // Thursday
                            { width: 14 }, // Friday
                            { width: 14 }  // Saturday
                        ];
                        
                        // Set row heights
                        ws['!rows'] = [];
                        for (let i = 0; i <= this.employees.length + 1; i++) {
                            ws['!rows'].push({ hpt: 35 });
                        }
                        
                        // Add week sheet with safe name (Excel has 31 char limit for sheet names)
                        const sheetName = `Week ${weekIndex + 1}`;
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    });
                    
                    // Create summary sheet
                    const summaryData = this.createSummarySheet(year, month, monthName);
                    const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
                    ws2['!cols'] = [{ width: 25 }, { width: 30 }];
                    XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
                    
                    // Create shifts sheet
                    const shiftsData = [
                        ['Shift Templates'],
                        [''],
                        ['Name', 'Start Time', 'End Time'],
                        ...this.shifts.map(s => [s.name, this.formatTime(s.startTime), this.formatTime(s.endTime)])
                    ];
                    const ws3 = XLSX.utils.aoa_to_sheet(shiftsData);
                    ws3['!cols'] = [{ width: 20 }, { width: 15 }, { width: 15 }];
                    XLSX.utils.book_append_sheet(wb, ws3, 'Shifts');
                    
                    // Generate filename
                    const filename = `${this.currentUser.region}_${this.currentUser.branch}_Schedule_${monthName.replace(' ', '_')}.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(wb, filename);
                    
                    this.showNotification('Schedule exported to Excel', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('Error exporting to Excel', 'error');
                }
            }

            getWeeksInMonth(year, month) {
                const weeks = [];
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                // Start from the Sunday of the week containing the first day of the month
                let currentWeekStart = new Date(firstDay);
                const dayOfWeek = currentWeekStart.getDay();
                if (dayOfWeek !== 0) {
                    currentWeekStart.setDate(currentWeekStart.getDate() - dayOfWeek);
                }
                
                while (currentWeekStart <= lastDay || currentWeekStart.getMonth() === month) {
                    const weekEnd = new Date(currentWeekStart);
                    weekEnd.setDate(currentWeekStart.getDate() + 6);
                    
                    weeks.push({
                        start: new Date(currentWeekStart),
                        end: new Date(weekEnd)
                    });
                    
                    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                    
                    // Stop if we've gone past the month
                    if (currentWeekStart.getMonth() > month && currentWeekStart.getFullYear() >= year) {
                        break;
                    }
                }
                
                return weeks;
            }

            createWeekSheet(week, weekNumber) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                
                // Create header rows
                const dateRow = ['Name'];
                const dayRow = [''];
                
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(week.start);
                    currentDate.setDate(week.start.getDate() + i);
                    
                    dateRow.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}/${currentDate.getFullYear()}`);
                    dayRow.push(dayNames[i]);
                }
                
                const weekData = [dateRow, dayRow];
                
                // Add employee rows
                this.employees.forEach(employee => {
                    const row = [employee.name];
                    
                    for (let i = 0; i < 7; i++) {
                        const currentDate = new Date(week.start);
                        currentDate.setDate(week.start.getDate() + i);
                        
                        const dateKey = this.getDateKey(
                            currentDate.getFullYear(), 
                            currentDate.getMonth(), 
                            currentDate.getDate()
                        );
                        const daySchedule = this.schedule[dateKey] || [];
                        
                        // Find this employee's shift for this day
                        const empShift = daySchedule.find(item => item.employeeId === employee.id);
                        
                        if (empShift) {
                            const shift = this.shifts.find(s => s.id === empShift.shiftId);
                            if (shift) {
                                row.push(`${shift.name}\n${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)}`);
                            } else {
                                row.push('');
                            }
                        } else {
                            row.push('OFF');
                        }
                    }
                    
                    weekData.push(row);
                });
                
                // Add empty row for spacing if there are employees
                if (this.employees.length > 0) {
                    weekData.push([]);
                }
                
                return weekData;
            }

            createSummarySheet(year, month, monthName) {
                const summaryData = [
                    ['Branch Schedule Summary'],
                    [''],
                    ['Region:', this.currentUser.region],
                    ['Branch:', this.currentUser.branch],
                    ['Month:', monthName],
                    ['Manager:', this.currentUser.email],
                    ['Export Date:', new Date().toLocaleString()],
                    [''],
                    ['Statistics'],
                    ['Total Employees:', this.employees.length],
                    ['Total Shift Types:', this.shifts.length],
                    ['Days Scheduled:', Object.keys(this.schedule).filter(key => {
                        const [y, m] = key.split('-').map(Number);
                        return y === year && m === (month + 1);
                    }).length],
                    [''],
                    ['Employee Schedule Summary'],
                    ['Employee', 'Days Scheduled', 'Total Hours']
                ];
                
                // Calculate employee statistics
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                this.employees.forEach(emp => {
                    let daysCount = 0;
                    let totalHours = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateKey = this.getDateKey(year, month, day);
                        const daySchedule = this.schedule[dateKey] || [];
                        const empShift = daySchedule.find(item => item.employeeId === emp.id);
                        
                        if (empShift) {
                            daysCount++;
                            const shift = this.shifts.find(s => s.id === empShift.shiftId);
                            if (shift) {
                                // Parse times more safely
                                const [startHour, startMin] = shift.startTime.split(':').map(Number);
                                const [endHour, endMin] = shift.endTime.split(':').map(Number);
                                
                                const startMinutes = startHour * 60 + startMin;
                                const endMinutes = endHour * 60 + endMin;
                                const hours = (endMinutes - startMinutes) / 60;
                                
                                totalHours += hours > 0 ? hours : 0;
                            }
                        }
                    }
                    
                    summaryData.push([emp.name, daysCount, totalHours.toFixed(1)]);
                });
                
                return summaryData;
            }

            exportSupervisorToExcel() {
                if (!this.selectedBranch) {
                    // Export all branches summary
                    const summaryData = [
                        ['All Branches Summary'],
                        ['Export Date:', new Date().toLocaleString()],
                        [''],
                        ['Branch', 'Region', 'Manager', 'Employees', 'Shift Types', 'Scheduled Days', 'Last Updated']
                    ];
                    
                    Object.keys(this.supervisorData).forEach(key => {
                        const branch = this.supervisorData[key];
                        const lastUpdated = branch.lastUpdated ? 
                            new Date(branch.lastUpdated.seconds * 1000).toLocaleString() : 
                            'Unknown';
                        
                        summaryData.push([
                            branch.user.branch,
                            branch.user.region,
                            branch.user.email,
                            branch.data.employees?.length || 0,
                            branch.data.shifts?.length || 0,
                            Object.keys(branch.data.schedule || {}).length,
                            lastUpdated
                        ]);
                    });
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(summaryData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { width: 20 }, // Branch
                        { width: 15 }, // Region
                        { width: 25 }, // Manager
                        { width: 12 }, // Employees
                        { width: 12 }, // Shift Types
                        { width: 15 }, // Scheduled Days
                        { width: 20 }  // Last Updated
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, 'All Branches');
                    XLSX.writeFile(wb, `All_Branches_Summary_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                } else {
                    // Export selected branch in weekly format
                    const branch = this.supervisorData[this.selectedBranch];
                    if (!branch) return;
                    
                    const year = this.supervisorCurrentDate.getFullYear();
                    const month = this.supervisorCurrentDate.getMonth();
                    const monthName = this.supervisorCurrentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    
                    // Get all weeks in the month
                    const weeks = this.getWeeksInMonth(year, month);
                    
                    // Create a sheet for each week
                    weeks.forEach((week, weekIndex) => {
                        const weekData = this.createSupervisorWeekSheet(week, weekIndex + 1, branch);
                        const ws = XLSX.utils.aoa_to_sheet(weekData);
                        
                        // Set column widths
                        ws['!cols'] = [
                            { width: 15 }, // Name column
                            { width: 14 }, // Sunday
                            { width: 14 }, // Monday
                            { width: 14 }, // Tuesday
                            { width: 14 }, // Wednesday
                            { width: 14 }, // Thursday
                            { width: 14 }, // Friday
                            { width: 14 }  // Saturday
                        ];
                        
                        // Set row heights
                        ws['!rows'] = [];
                        for (let i = 0; i <= (branch.data.employees?.length || 0) + 1; i++) {
                            ws['!rows'].push({ hpt: 35 });
                        }
                        
                        // Add week sheet
                        const sheetName = `Week ${weekIndex + 1} (${week.start.getMonth() + 1}/${week.start.getDate()})`;
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    });
                    
                    // Create summary sheet
                    const lastUpdated = branch.lastUpdated ? 
                        new Date(branch.lastUpdated.seconds * 1000).toLocaleString() : 
                        'Unknown';
                    
                    const summaryData = [
                        ['Branch Schedule Summary'],
                        [''],
                        ['Region:', branch.user.region],
                        ['Branch:', branch.user.branch],
                        ['Month:', monthName],
                        ['Manager:', branch.user.email],
                        ['Last Updated:', lastUpdated],
                        ['Export Date:', new Date().toLocaleString()],
                        [''],
                        ['Statistics'],
                        ['Total Employees:', branch.data.employees?.length || 0],
                        ['Total Shift Types:', branch.data.shifts?.length || 0],
                        ['Days Scheduled:', Object.keys(branch.data.schedule || {}).filter(key => {
                            const [y, m] = key.split('-').map(Number);
                            return y === year && m === (month + 1);
                        }).length],
                        [''],
                        ['Employee Schedule Summary'],
                        ['Employee', 'Days Scheduled', 'Total Hours']
                    ];
                    
                    // Calculate employee statistics
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    if (branch.data.employees) {
                        branch.data.employees.forEach(emp => {
                            let daysCount = 0;
                            let totalHours = 0;
                            
                            for (let day = 1; day <= daysInMonth; day++) {
                                const dateKey = this.getDateKey(year, month, day);
                                const daySchedule = branch.data.schedule[dateKey] || [];
                                const empShift = daySchedule.find(item => item.employeeId === emp.id);
                                
                                if (empShift) {
                                    daysCount++;
                                    const shift = branch.data.shifts?.find(s => s.id === empShift.shiftId);
                                    if (shift) {
                                        const start = new Date(`2000/01/01 ${shift.startTime}`);
                                        const end = new Date(`2000/01/01 ${shift.endTime}`);
                                        const hours = (end - start) / (1000 * 60 * 60);
                                        totalHours += hours;
                                    }
                                }
                            }
                            
                            summaryData.push([emp.name, daysCount, totalHours.toFixed(1)]);
                        });
                    }
                    
                    const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
                    ws2['!cols'] = [{ width: 25 }, { width: 20 }, { width: 15 }];
                    XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
                    
                    // Create shifts list
                    const shiftsData = [
                        ['Shift Templates'],
                        [''],
                        ['Name', 'Start Time', 'End Time'],
                        ...(branch.data.shifts?.map(s => [s.name, this.formatTime(s.startTime), this.formatTime(s.endTime)]) || [])
                    ];
                    const ws3 = XLSX.utils.aoa_to_sheet(shiftsData);
                    ws3['!cols'] = [{ width: 20 }, { width: 15 }, { width: 15 }];
                    XLSX.utils.book_append_sheet(wb, ws3, 'Shifts');
                    
                    // Generate filename
                    const filename = `${branch.user.region}_${branch.user.branch}_Schedule_${monthName.replace(' ', '_')}.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(wb, filename);
                }
                
                this.showNotification('Report exported to Excel', 'success');
            }

            createSupervisorWeekSheet(week, weekNumber, branch) {
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                
                // Create header rows
                const dateRow = ['Name'];
                const dayRow = [''];
                
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(week.start);
                    currentDate.setDate(week.start.getDate() + i);
                    
                    dateRow.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}/${currentDate.getFullYear()}`);
                    dayRow.push(dayNames[i]);
                }
                
                const weekData = [dateRow, dayRow];
                
                // Add employee rows
                if (branch.data.employees && branch.data.employees.length > 0) {
                    branch.data.employees.forEach(employee => {
                        const row = [employee.name];
                        
                        for (let i = 0; i < 7; i++) {
                            const currentDate = new Date(week.start);
                            currentDate.setDate(week.start.getDate() + i);
                            
                            const dateKey = this.getDateKey(
                                currentDate.getFullYear(), 
                                currentDate.getMonth(), 
                                currentDate.getDate()
                            );
                            const daySchedule = branch.data.schedule[dateKey] || [];
                            
                            // Find this employee's shift for this day
                            const empShift = daySchedule.find(item => item.employeeId === employee.id);
                            
                            if (empShift) {
                                const shift = branch.data.shifts?.find(s => s.id === empShift.shiftId);
                                if (shift) {
                                    row.push(`${shift.name}\n${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)}`);
                                } else {
                                    row.push('');
                                }
                            } else {
                                row.push('OFF');
                            }
                        }
                        
                        weekData.push(row);
                    });
                } else {
                    weekData.push(['No employees scheduled']);
                }
                
                // Add empty row for spacing
                weekData.push([]);
                
                return weekData;
            }

            applyBulkSchedule() {
                const startDate = new Date(document.getElementById('bulkStart').value);
                const endDate = new Date(document.getElementById('bulkEnd').value);
                
                if (!startDate || !endDate || startDate > endDate) {
                    this.showNotification('Please select valid date range', 'error');
                    return;
                }
                
                const includeSaturdays = document.getElementById('includeSaturdays')?.checked;
                let count = 0;
                
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    const dayOfWeek = date.getDay();
                    
                    // Skip Sundays always
                    if (dayOfWeek === 0) continue;
                    
                    // Handle Saturdays separately
                    if (dayOfWeek === 6) {
                        if (!includeSaturdays) continue;
                        
                        const dateKey = this.getDateKey(date.getFullYear(), date.getMonth(), date.getDate());
                        
                        this.shifts.forEach(shift => {
                            this.employees.forEach(employee => {
                                // Use Saturday-specific checkboxes
                                const checkbox = document.getElementById(`bulk-sat-${shift.id}-${employee.id}`);
                                if (!checkbox?.checked) return;
                                
                                if (!this.schedule[dateKey]) this.schedule[dateKey] = [];
                                
                                if (!this.schedule[dateKey].some(item => 
                                    item.employeeId === employee.id && item.shiftId === shift.id)) {
                                    this.schedule[dateKey].push({
                                        id: this.generateId(),
                                        employeeId: employee.id,
                                        shiftId: shift.id,
                                        date: dateKey
                                    });
                                    count++;
                                }
                            });
                        });
                    } else {
                        // Weekdays (Mon-Fri)
                        const dateKey = this.getDateKey(date.getFullYear(), date.getMonth(), date.getDate());
                        
                        this.shifts.forEach(shift => {
                            this.employees.forEach(employee => {
                                // Use weekday checkboxes
                                const checkbox = document.getElementById(`bulk-${shift.id}-${employee.id}`);
                                if (!checkbox?.checked) return;
                                
                                if (!this.schedule[dateKey]) this.schedule[dateKey] = [];
                                
                                if (!this.schedule[dateKey].some(item => 
                                    item.employeeId === employee.id && item.shiftId === shift.id)) {
                                    this.schedule[dateKey].push({
                                        id: this.generateId(),
                                        employeeId: employee.id,
                                        shiftId: shift.id,
                                        date: dateKey
                                    });
                                    count++;
                                }
                            });
                        });
                    }
                }
                
                this.triggerAutoSave();
                this.renderCalendar();
                this.closeModal('bulkModal');
                this.showNotification(`Scheduled ${count} shifts!`);
            }

            clearMonth() {
                if (!confirm('Clear all shifts for this month?')) return;
                
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const lastDay = new Date(year, month + 1, 0).getDate();
                
                for (let day = 1; day <= lastDay; day++) {
                    delete this.schedule[this.getDateKey(year, month, day)];
                }
                
                this.triggerAutoSave();
                this.renderCalendar();
                this.showNotification('Month cleared!');
            }

            // Render Methods
            updateUI() {
                if (this.currentUser) {
                    document.getElementById('branchInfo').textContent = 
                        `${this.currentUser.region} Region - ${this.currentUser.branch} Branch`;
                }
                this.renderEmployees();
                this.renderShifts();
                this.renderCalendar();
            }

            renderEmployees() {
                const container = document.getElementById('employeeList');
                
                if (!this.employees.length) {
                    container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No employees added yet</p>';
                    return;
                }
                
                container.innerHTML = this.employees.map(emp => `
                    <div class="employee-card">
                        <span>${emp.name}</span>
                        <button class="btn btn-danger btn-small" data-action="removeEmployee" data-id="${emp.id}">×</button>
                    </div>
                `).join('');
            }

            renderShifts() {
                const container = document.getElementById('shiftList');
                
                if (!this.shifts.length) {
                    container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No shift templates created yet</p>';
                    return;
                }
                
                container.innerHTML = this.shifts.map(shift => `
                    <div class="shift-card">
                        ${shift.isNew ? `
                            <div class="shift-form">
                                <div>
                                    <label>Shift Name</label>
                                    <input type="text" id="shift-name-${shift.id}" class="form-input" placeholder="Morning Shift" value="${shift.name}">
                                </div>
                                <div>
                                    <label>Start Time</label>
                                    <input type="time" id="shift-start-${shift.id}" class="form-input" value="${shift.startTime}">
                                </div>
                                <div>
                                    <label>End Time</label>
                                    <input type="time" id="shift-end-${shift.id}" class="form-input" value="${shift.endTime}">
                                </div>
                                <div>
                                    <label>Color</label>
                                    <input type="color" id="shift-color-${shift.id}" class="form-input" value="${shift.color}">
                                    <button class="btn btn-success btn-small" data-action="saveShift" data-id="${shift.id}" style="margin-top: 10px; width: 100%;">Save</button>
                                </div>
                            </div>
                        ` : `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3>${shift.name}</h3>
                                    <p>${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)}</p>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div style="width: 20px; height: 20px; background: ${shift.color}; border-radius: 4px;"></div>
                                    <button class="btn btn-danger btn-small" data-action="removeShift" data-id="${shift.id}">Delete</button>
                                </div>
                            </div>
                        `}
                    </div>
                `).join('');
            }

            renderCalendar() {
                const calendar = document.getElementById('calendar');
                const monthTitle = document.getElementById('monthTitle');
                
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const today = new Date();
                
                monthTitle.textContent = new Intl.DateTimeFormat('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                }).format(this.currentDate);
                
                calendar.innerHTML = '';
                
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    calendar.appendChild(dayHeader);
                });
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day other-month';
                    calendar.appendChild(emptyDay);
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    const dayDate = new Date(year, month, day);
                    if (dayDate.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    dayElement.dataset.date = JSON.stringify({ year, month, day });
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = day;
                    dayElement.appendChild(dayNumber);
                    
                    const dateKey = this.getDateKey(year, month, day);
                    const daySchedule = this.schedule[dateKey] || [];
                    
                    daySchedule.forEach(item => {
                        const employee = this.employees.find(e => e.id === item.employeeId);
                        const shift = this.shifts.find(s => s.id === item.shiftId);
                        
                        if (employee && shift) {
                            const shiftItem = document.createElement('div');
                            shiftItem.className = 'shift-item';
                            shiftItem.style.background = shift.color;
                            shiftItem.textContent = `${employee.name} (${this.formatTime(shift.startTime)}-${this.formatTime(shift.endTime)})`;
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-shift';
                            removeBtn.innerHTML = '×';
                            removeBtn.dataset.dateKey = dateKey;
                            removeBtn.dataset.itemId = item.id;
                            shiftItem.appendChild(removeBtn);
                            
                            dayElement.appendChild(shiftItem);
                        }
                    });
                    
                    calendar.appendChild(dayElement);
                }
            }

            renderSupervisorDashboard() {
                const branchKeys = Object.keys(this.supervisorData);
                
                if (!branchKeys.length) {
                    document.getElementById('supervisorStats').innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No branch data available yet</p>';
                    document.getElementById('branchSelector').classList.add('hidden');
                    document.getElementById('supervisorContent').innerHTML = '';
                    return;
                }
                
                let totalEmployees = 0, totalShifts = 0, totalDays = 0;
                
                branchKeys.forEach(key => {
                    const branch = this.supervisorData[key];
                    totalEmployees += branch.data.employees?.length || 0;
                    totalShifts += branch.data.shifts?.length || 0;
                    totalDays += Object.keys(branch.data.schedule || {}).length;
                });
                
                document.getElementById('supervisorStats').innerHTML = `
                    <div class="stat-card"><div class="stat-number">${branchKeys.length}</div><div class="stat-label">Branches</div></div>
                    <div class="stat-card"><div class="stat-number">${totalEmployees}</div><div class="stat-label">Total Employees</div></div>
                    <div class="stat-card"><div class="stat-number">${totalShifts}</div><div class="stat-label">Shift Templates</div></div>
                    <div class="stat-card"><div class="stat-number">${totalDays}</div><div class="stat-label">Scheduled Days</div></div>
                `;
                
                document.getElementById('branchSelector').classList.remove('hidden');
                const dropdown = document.getElementById('branchDropdown');
                dropdown.innerHTML = '<option value="">Choose a branch...</option>' + 
                    branchKeys.map(key => {
                        const branch = this.supervisorData[key];
                        return `<option value="${key}">${branch.user.region} - ${branch.user.branch}</option>`;
                    }).join('');
                
                document.getElementById('supervisorContent').innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Select a branch above to view detailed schedules</p>';
            }

            selectBranch(branchKey) {
                if (!branchKey) {
                    document.getElementById('supervisorContent').innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Select a branch above to view detailed schedules</p>';
                    return;
                }
                
                const branch = this.supervisorData[branchKey];
                if (!branch) return;
                
                // Store for calendar navigation
                this.selectedBranch = branchKey;
                this.supervisorCurrentDate = new Date();
                
                const lastUpdated = branch.lastUpdated ? 
                    new Date(branch.lastUpdated.seconds * 1000).toLocaleString() : 
                    'Unknown';
                
                document.getElementById('supervisorContent').innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h2>${branch.user.region} Region - ${branch.user.branch} Branch</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 18px; font-weight: 600; color: #2563eb;">${branch.data.employees?.length || 0}</div>
                                <div style="color: #64748b;">Employees</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 18px; font-weight: 600; color: #2563eb;">${branch.data.shifts?.length || 0}</div>
                                <div style="color: #64748b;">Shift Templates</div>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 18px; font-weight: 600; color: #2563eb;">${Object.keys(branch.data.schedule || {}).length}</div>
                                <div style="color: #64748b;">Scheduled Days</div>
                            </div>
                        </div>
                        <p><strong>Manager:</strong> ${branch.user.email}</p>
                        <p><strong>Last Updated:</strong> ${lastUpdated}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h3 style="margin-bottom: 15px;">Shift Templates</h3>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; min-height: 200px;">
                                ${branch.data.shifts?.length ? branch.data.shifts.map(shift => `
                                    <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid ${shift.color};">
                                        <strong>${shift.name}</strong><br>
                                        <small>${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)}</small>
                                    </div>
                                `).join('') : '<p style="color: #64748b;">No shift templates</p>'}
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom: 15px;">Employees</h3>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; min-height: 200px;">
                                ${branch.data.employees?.length ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${branch.data.employees.map(employee => `
                                            <span style="background: white; padding: 6px 12px; border-radius: 16px; font-size: 14px;">
                                                ${employee.name}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color: #64748b;">No employees</p>'}
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 15px;">Branch Schedule Calendar</h3>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                            <div class="month-nav">
                                <button class="btn btn-secondary" id="supervisorPrevBtn">← Previous</button>
                                <h3 class="month-title" id="supervisorMonthTitle">January 2024</h3>
                                <button class="btn btn-secondary" id="supervisorNextBtn">Next →</button>
                            </div>
                            
                            <div class="calendar" id="supervisorCalendar"></div>
                        </div>
                    </div>
                `;
                
                this.renderSupervisorCalendar();
            }

            renderSupervisorCalendar() {
                if (!this.selectedBranch || !this.supervisorCurrentDate) return;
                
                const branch = this.supervisorData[this.selectedBranch];
                if (!branch) return;
                
                const calendar = document.getElementById('supervisorCalendar');
                const monthTitle = document.getElementById('supervisorMonthTitle');
                
                const year = this.supervisorCurrentDate.getFullYear();
                const month = this.supervisorCurrentDate.getMonth();
                const today = new Date();
                
                monthTitle.textContent = new Intl.DateTimeFormat('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                }).format(this.supervisorCurrentDate);
                
                calendar.innerHTML = '';
                
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    calendar.appendChild(dayHeader);
                });
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day other-month';
                    calendar.appendChild(emptyDay);
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    const dayDate = new Date(year, month, day);
                    if (dayDate.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = day;
                    dayElement.appendChild(dayNumber);
                    
                    const dateKey = this.getDateKey(year, month, day);
                    const daySchedule = branch.data.schedule[dateKey] || [];
                    
                    daySchedule.forEach(item => {
                        const employee = branch.data.employees?.find(e => e.id === item.employeeId);
                        const shift = branch.data.shifts?.find(s => s.id === item.shiftId);
                        
                        if (employee && shift) {
                            const shiftItem = document.createElement('div');
                            shiftItem.className = 'shift-item';
                            shiftItem.style.background = shift.color;
                            shiftItem.style.cursor = 'default';
                            shiftItem.textContent = `${employee.name} (${this.formatTime(shift.startTime)}-${this.formatTime(shift.endTime)})`;
                            shiftItem.title = `${employee.name} - ${shift.name}\n${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)}`;
                            
                            dayElement.appendChild(shiftItem);
                        }
                    });
                    
                    calendar.appendChild(dayElement);
                }
            }

            openModal(modalId, data = {}) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                
                if (modalId === 'dayModal') {
                    if (!this.employees.length || !this.shifts.length) {
                        this.showNotification('Add employees and shifts first', 'warning');
                        return;
                    }
                    
                    const { year, month, day } = data;
                    const dateKey = this.getDateKey(year, month, day);
                    const daySchedule = this.schedule[dateKey] || [];
                    const date = new Date(year, month, day);
                    
                    document.getElementById('dayModalTitle').textContent = 
                        `Schedule for ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                    
                    document.getElementById('dayModalContent').innerHTML = this.shifts.map(shift => {
                        const assignedEmployees = daySchedule.filter(item => item.shiftId === shift.id).map(item => item.employeeId);
                        
                        return `
                            <div class="shift-group">
                                <h4>${shift.name} (${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)})</h4>
                                <div class="checkbox-list">
                                    ${this.employees.map(emp => `
                                        <div class="checkbox-item">
                                            <input type="checkbox" 
                                                   id="assign-${shift.id}-${emp.id}"
                                                   data-datekey="${dateKey}"
                                                   data-employee="${emp.id}"
                                                   data-shift="${shift.id}"
                                                   ${assignedEmployees.includes(emp.id) ? 'checked' : ''}>
                                            <label for="assign-${shift.id}-${emp.id}">${emp.name}</label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } else if (modalId === 'bulkModal') {
                    if (!this.employees.length || !this.shifts.length) {
                        this.showNotification('Add employees and shifts first', 'warning');
                        return;
                    }
                    
                    const today = new Date();
                    const monday = new Date(today);
                    monday.setDate(today.getDate() - today.getDay() + 1);
                    const friday = new Date(monday);
                    friday.setDate(monday.getDate() + 4);
                    
                    document.getElementById('bulkStart').value = monday.toISOString().split('T')[0];
                    document.getElementById('bulkEnd').value = friday.toISOString().split('T')[0];
                    
                    document.getElementById('bulkContent').innerHTML = `
                        <h4 style="margin-bottom: 15px; color: #2563eb;">Weekday Schedule (Mon-Fri)</h4>
                        ${this.shifts.map(shift => `
                            <div class="shift-group">
                                <h4>${shift.name} (${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)})</h4>
                                <div class="checkbox-list">
                                    ${this.employees.map(emp => `
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="bulk-${shift.id}-${emp.id}">
                                            <label for="bulk-${shift.id}-${emp.id}">${emp.name}</label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <input type="checkbox" id="includeSaturdays" checked>
                                <label for="includeSaturdays" style="font-weight: 600; color: #2563eb;">Include Saturdays</label>
                            </div>
                            <div id="saturdaySection">
                                <h4 style="margin-bottom: 15px; color: #059669;">Saturday Schedule</h4>
                                ${this.shifts.map(shift => `
                                    <div class="shift-group">
                                        <h4>${shift.name} (${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)})</h4>
                                        <div class="checkbox-list">
                                            ${this.employees.map(emp => `
                                                <div class="checkbox-item">
                                                    <input type="checkbox" id="bulk-sat-${shift.id}-${emp.id}">
                                                    <label for="bulk-sat-${shift.id}-${emp.id}">${emp.name}</label>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                modal.style.display = 'block';
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            }

            // Initialize app
            init() {
                // Login type switcher
                document.querySelectorAll('.login-type').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.userType = e.target.dataset.type;
                        document.querySelectorAll('.login-type').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        document.getElementById('managerFields').classList.toggle('hidden', this.userType === 'supervisor');
                        document.getElementById('supervisorFields').classList.toggle('hidden', this.userType === 'manager');
                    });
                });

                // Region/Branch selector
                document.getElementById('region').addEventListener('change', (e) => {
                    const branchSelect = document.getElementById('branch');
                    branchSelect.innerHTML = '<option value="">Select Branch</option>';
                    
                    if (e.target.value && this.branches[e.target.value]) {
                        this.branches[e.target.value].forEach(branch => {
                            const option = document.createElement('option');
                            option.value = branch;
                            option.textContent = branch;
                            branchSelect.appendChild(option);
                        });
                    }
                });

                // Login form
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = this.userType === 'supervisor' ? 
                        document.getElementById('supervisorEmail').value : 
                        document.getElementById('email').value;
                    const password = this.userType === 'supervisor' ? 
                        document.getElementById('supervisorPassword').value : 
                        document.getElementById('password').value;
                    const region = this.userType === 'manager' ? document.getElementById('region').value : null;
                    const branch = this.userType === 'manager' ? document.getElementById('branch').value : null;
                    
                    if (!email || !password || (this.userType === 'manager' && (!region || !branch))) {
                        this.showNotification('Please fill in all fields', 'error');
                        return;
                    }
                    
                    await this.login(email, password, region, branch);
                });

                // Tab switcher
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(e.target.dataset.tab + 'Tab').classList.add('active');
                    });
                });

                // Button handlers
                document.getElementById('saveBtn')?.addEventListener('click', () => this.saveToFirebase());
                document.getElementById('exportBtn')?.addEventListener('click', () => this.exportToExcel());
                document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());
                document.getElementById('supervisorExportBtn')?.addEventListener('click', () => this.exportToExcel());
                document.getElementById('supervisorLogoutBtn')?.addEventListener('click', () => this.logout());
                
                document.getElementById('addEmployeeBtn')?.addEventListener('click', () => {
                    const input = document.getElementById('newEmployeeName');
                    this.addEmployee(input.value);
                    input.value = '';
                });
                
                document.getElementById('newEmployeeName')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.addEmployee(e.target.value);
                        e.target.value = '';
                    }
                });
                
                document.getElementById('addShiftBtn')?.addEventListener('click', () => this.addShift());
                document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.renderCalendar();
                });
                document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.renderCalendar();
                });
                document.getElementById('bulkBtn')?.addEventListener('click', () => this.openModal('bulkModal'));
                document.getElementById('clearBtn')?.addEventListener('click', () => this.clearMonth());
                
                document.getElementById('bulkCancelBtn')?.addEventListener('click', () => this.closeModal('bulkModal'));
                document.getElementById('bulkApplyBtn')?.addEventListener('click', () => this.applyBulkSchedule());

                // Supervisor branch selector
                document.getElementById('branchDropdown')?.addEventListener('change', (e) => {
                    this.selectBranch(e.target.value);
                });

                // Event delegation for dynamic elements
                document.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    // Handle action buttons
                    if (target.dataset.action) {
                        const action = target.dataset.action;
                        const id = target.dataset.id;
                        
                        switch(action) {
                            case 'removeEmployee': this.removeEmployee(id); break;
                            case 'saveShift': this.saveShift(id); break;
                            case 'removeShift': this.removeShift(id); break;
                        }
                    }
                    
                    // Handle calendar days
                    if (target.classList.contains('calendar-day') && !target.classList.contains('other-month')) {
                        const data = JSON.parse(target.dataset.date || '{}');
                        if (data.year) this.openModal('dayModal', data);
                    }
                    
                    // Handle remove shift buttons
                    if (target.classList.contains('remove-shift')) {
                        e.stopPropagation();
                        this.removeScheduleItem(target.dataset.dateKey, target.dataset.itemId);
                    }
                    
                    // Handle modal close buttons
                    if (target.classList.contains('close-btn')) {
                        const modal = target.closest('.modal');
                        if (modal) this.closeModal(modal.id);
                    }
                    
                    // Handle day modal Done button
                    if (target.id === 'dayModalDone') {
                        this.closeModal('dayModal');
                    }
                    
                    // Handle modal backgrounds
                    if (target.classList.contains('modal')) {
                        this.closeModal(target.id);
                    }
                    
                    // Handle supervisor calendar navigation
                    if (target.id === 'supervisorPrevBtn') {
                        this.supervisorCurrentDate.setMonth(this.supervisorCurrentDate.getMonth() - 1);
                        this.renderSupervisorCalendar();
                    }
                    
                    if (target.id === 'supervisorNextBtn') {
                        this.supervisorCurrentDate.setMonth(this.supervisorCurrentDate.getMonth() + 1);
                        this.renderSupervisorCalendar();
                    }
                });

                // Event delegation for schedule checkboxes
                document.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox' && e.target.id?.startsWith('assign-')) {
                        this.toggleSchedule(
                            e.target.dataset.datekey,
                            e.target.dataset.employee,
                            e.target.dataset.shift,
                            e.target.checked
                        );
                    }
                    
                    // Toggle Saturday section visibility
                    if (e.target.id === 'includeSaturdays') {
                        const saturdaySection = document.getElementById('saturdaySection');
                        if (saturdaySection) {
                            saturdaySection.style.display = e.target.checked ? 'block' : 'none';
                        }
                    }
                });
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', () => new App());
    </script>
</body>
</html>
